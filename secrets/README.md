# Secrets Management with sops-nix

This directory contains encrypted secrets managed by [sops](https://github.com/mozilla/sops) and integrated with NixOS via [sops-nix](https://github.com/Mic92/sops-nix).

## Directory Structure

```
secrets/
├── .sops.yaml          # sops configuration with creation rules
├── smb.yaml            # SMB/CIFS credentials
└── README.md           # This file
```

## Initial Setup

### 1. Age Key Setup
Your age key is configured at `~/.config/sops/age/keys.txt` and will be auto-generated by sops-nix on first boot.

If you need to manually manage the key:
```bash
# Generate new key (only if needed)
mkdir -p ~/.config/sops/age
age-keygen -o ~/.config/sops/age/keys.txt

# View your public key (to share with others)
age-keygen -y ~/.config/sops/age/keys.txt
```

### 2. Set Up SMB Secrets

1. **Edit the unencrypted SMB template:**
   ```bash
   # Replace placeholder values with real credentials
   $EDITOR secrets/smb.yaml
   ```

2. **Encrypt the SMB secrets:**
   ```bash
   cd secrets
   sops -e -i smb.yaml
   ```

## Daily Usage

### Direct sops Commands
```bash
cd secrets

# Edit SMB credentials
sops smb.yaml

# View SMB secrets
sops -d smb.yaml
```

### Adding New Secret Files

1. **Create the new secret file:**
   ```bash
   echo "new_secret: your_value_here" > secrets/new-service.yaml
   ```

2. **Add creation rule to `.sops.yaml`:**
   ```yaml
   - path_regex: new-service\.yaml$
     key_groups:
     - age:
       - *emil
   ```

3. **Encrypt the file:**
   ```bash
   sops -e -i secrets/new-service.yaml
   ```

4. **Add to sops configuration:**
   ```nix
   sops.secrets.new_secret = {
     sopsFile = ./secrets/new-service.yaml;
     owner = config.users.users.emil.name;
     group = config.users.groups.users.name;
     mode = "0400";
   };
   ```

## How sops-nix Integration Works

### Secret Mounting
- Encrypted files are decrypted at boot and mounted to `/run/secrets/`
- Example: `smb_username` secret → `/run/secrets/smb_username`

### Template System
- Use `config.sops.placeholder.secret_name` in templates
- Templates are rendered to `/run/secrets-rendered/`
- Example: SMB credentials template → `/run/secrets-rendered/smb-credentials`

### Configuration Files

**flake.nix**: Defines which secrets to decrypt and where to place them
**nixos/common/cifs.nix**: Uses sops templates for SMB credential file generation

## Current Secrets

- `smb_username` - SMB/CIFS username for NAS access
- `smb_password` - SMB/CIFS password for NAS access
- `smb_server_ip` - SMB/CIFS server IP address for NAS access

## Troubleshooting

### Secret Not Decrypting
```bash
# Check if age key exists and is readable
ls -la ~/.config/sops/age/keys.txt

# Test decryption manually
cd secrets
sops -d smb.yaml
```

### System Build Failures
```bash
# Verify all secrets are properly encrypted
cd secrets
for file in *.yaml; do
    echo "Checking $file..."
    sops -d "$file" > /dev/null && echo "✓ OK" || echo "✗ FAILED"
done
```

### Template Generation Issues
```bash
# Check if secrets are mounted
ls -la /run/secrets/

# Check if templates are rendered
ls -la /run/secrets-rendered/

# View systemd logs
journalctl -u sops-nix.service
```

## Security Notes

- **Never commit unencrypted secrets** to git
- Age keys in `~/.config/sops/age/keys.txt` should be backed up securely
- Each secret file can have different access permissions and ownership
- Templates allow safe composition of secrets into configuration files
- The age private key is automatically generated and stored in `/home/emil/.config/sops/age/keys.txt`
- Only encrypted secrets are committed to git
- Secrets are automatically decrypted at boot time by sops-nix
- User-level key storage keeps secrets accessible to your user account
